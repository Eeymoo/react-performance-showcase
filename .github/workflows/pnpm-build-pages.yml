name: PNPM React CI/CD to GitHub Pages

on:
  push:
    branches:
      - main   # ä¸»åˆ†æ”¯è§¦å‘éƒ¨ç½²
      - dev    # å¼€å‘åˆ†æ”¯è§¦å‘æµ‹è¯•æ„å»º
  pull_request:
    branches:
      - main   # PRåˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œæµ‹è¯•

jobs:
  build-test:
    name: Build and Test with PNPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'pnpm' # å¯ç”¨ pnpm ç¼“å­˜
          
      # å®‰è£… PNPM (å¦‚æœæœªé¢„è£…)
      - name: Install PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8.x
          
      # PNPM ç¼“å­˜è®¾ç½®
      - name: Configure PNPM cache
        uses: pnpm/action-setup@v2
        with:
          run_install: false
          
      # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ PNPM ç¼“å­˜ï¼‰
      - name: Install dependencies with PNPM
        run: pnpm install --frozen-lockfile
        
      # è¿è¡Œä»£ç è§„èŒƒæ£€æŸ¥
      - name: Run linting
        run: pnpm lint
        
      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: pnpm test -- --coverage
        env:
          CI: true
          
      # æ„å»ºç”Ÿäº§åŒ…
      - name: Build production bundle
        run: pnpm build
          
      # ä¿å­˜æ„å»ºäº§ç‰©ï¼ˆç”¨äºéƒ¨ç½²é˜¶æ®µï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: react-build
          path: build/ # create-react-app é»˜è®¤è¾“å‡ºç›®å½•

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-test    # ä¾èµ–æ„å»ºä»»åŠ¡å®Œæˆ
    if: ${{ github.ref == 'refs/heads/main' }} # ä»…ä¸»åˆ†æ”¯éƒ¨ç½²
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: react-build
          path: build/
          
      # éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          # é…ç½®å•é¡µåº”ç”¨è·¯ç”±
          enable_jekyll: false # ç¦ç”¨ Jekyll å¤„ç†
          # å¯é€‰çš„ CNAME è®¾ç½® (å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸå)
          # cname: yourdomain.com
          
      # åˆ é™¤æ„å»ºäº§ç‰©ä»¥èŠ‚çœç©ºé—´
      - name: Clean up artifacts
        run: rm -rf build/
        
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy-pages
    if: ${{ always() }} # æ— è®ºéƒ¨ç½²æ˜¯å¦æˆåŠŸéƒ½å‘é€é€šçŸ¥
    
    steps:
      - name: Get deployment status
        id: deployment_status
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
        
      # éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Send success notification
        if: ${{ steps.deployment_status.outputs.status == 'success' }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: "React App å·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pages! ğŸš€\nè®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          SLACK_COLOR: "#36a64f"
        
      # éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: Send failure notification
        if: ${{ steps.deployment_status.outputs.status == 'failure' }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: "âš ï¸ éƒ¨ç½²åˆ° GitHub Pages å¤±è´¥! \nè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SLACK_COLOR: "#ff0000"
